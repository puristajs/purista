import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,a as e}from"./app-cbf1ff6b.js";const t="/graphic/builder.svg",o={},p=e('<p>PURISTA has the concept of builders to define services, functions and subscriptions. But why is this needed?</p><p>There is a need to define services, attach functions and subscriptions. And each function or subscription has also properties, configurations, options and so on.</p><p>One simple option would be, to have some code generators. This is a solid concept, and very often used in frameworks. But it has some disadvantages. You get some bootstrap code, and align, extent, and change the generated code. You will also need some more or less fixed folder structure, which reduces the freedom of developers.</p><p>While code generation in general is a great tool, they are not the best choice for our needs here.<br> PURISTA tries to be decoupled from the underlaying system and infrastructure. So, we might need a way to convert our settings into a specific architecture, for a specific infrastructure or cloud provider. This conversion might be on the fly. So we will need to access and interpret the setup programmatically. Also, we want to avoid manual configurations and manual steps as much as possible. They are time-consuming and error-prone.</p><h2 id="cascading" tabindex="-1"><a class="header-anchor" href="#cascading" aria-hidden="true">#</a> Cascading</h2><p>There are several parts, where one setting or configuration is impacting a whole service. For example, the custom configuration for a service might change. You probably don&#39;t want to change several functions and subscriptions, only because you add a simple property.</p><p>Types are dynamically set and generated. You can take the input for a function as an example. You have set the input schema, which generates the input typescript type for your function. It also sets the type of message payload and maybe generates the OpenApi definition.</p><p>Now, if you add a input payload transform hook, the type of message payload and the OpenApi definition will change. The hook function itself will also have some input/output types.</p><p>There is a bunch of type definition stuff behind the scene, to ensure correct types, correct input and outputs. This improves speed during development, reduces the costs for maintaining code, and prevents bugs.</p><p>To get an idea, take a look at this diagram. This is a kind of typescript-type dependency graph. This is the stuff you would need to manage within your code and your brain, without builders.</p><p><img src="'+t+`" alt="Example"></p><div class="hint-container warning"><p class="hint-container-title">Order matters</p><p>You must declare the input and output schemas before adding transforms, hooks and functions!<br> As you can see in the diagram above, they impact the input/output types of transforms, hooks and functions.</p></div><h2 id="service-builder" tabindex="-1"><a class="header-anchor" href="#service-builder" aria-hidden="true">#</a> Service Builder</h2><p>As the first step, we will need to set up a service. This can be done by using the service builder.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ServiceBuilder<span class="token punctuation">,</span> ServiceInfoType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@purista/core&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> myServiceInfo<span class="token operator">:</span> ServiceInfoType <span class="token operator">=</span> <span class="token punctuation">{</span>
  serviceName<span class="token operator">:</span> <span class="token string">&#39;MyService&#39;</span><span class="token punctuation">,</span>
  serviceVersion<span class="token operator">:</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span>
  serviceDescription<span class="token operator">:</span> <span class="token string">&#39;my service&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> UserServiceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBuilder</span><span class="token punctuation">(</span>myServiceInfo<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You might need some general service configuration, which is accessible within the service functions and subscriptions.<br> You can quickly set up a schema validated configuration like this:</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ServiceBuilder<span class="token punctuation">,</span> ServiceInfoType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@purista/core&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;zod&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> myServiceInfo<span class="token operator">:</span> ServiceInfoType <span class="token operator">=</span> <span class="token punctuation">{</span>
  serviceName<span class="token operator">:</span> <span class="token string">&#39;MyService&#39;</span><span class="token punctuation">,</span>
  serviceVersion<span class="token operator">:</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span>
  serviceDescription<span class="token operator">:</span> <span class="token string">&#39;my service&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> myConfiguration <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  requiredOption<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  optionalOption<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  optionalWithDefaultOption<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> myServiceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBuilder</span><span class="token punctuation">(</span>myServiceInfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setConfigSchema</span><span class="token punctuation">(</span>myConfiguration<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You are now able to use a custom configuration, which is accessible within the service functions and subscriptions with <code>this.config</code>.<br> The types are automatically generated and available in functions and subscriptions.<br> You can set a configuration, when you create a new instance of your service.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> customConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  requiredOption<span class="token operator">:</span> <span class="token string">&#39;set to value&#39;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> myService <span class="token operator">=</span> myServiceBuilder<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>baseLogger<span class="token punctuation">,</span> eventBridge<span class="token punctuation">,</span> customConfig<span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>As you can see, the types are kind of intelligent. The type of setting the configuration during instance creation, differs from the configuration type which is available within your functions and subscriptions.<br> By using a schema validation, your service will fail on instance creation, if the configuration is invalid. The error will be automatically logged.</p><p>There is also the option to set a default configuration. The default configuration will be merged with the provided custom configuration.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> myServiceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBuilder</span><span class="token punctuation">(</span>myServiceInfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setConfigSchema</span><span class="token punctuation">(</span>myConfiguration<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setDefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    requiredOption<span class="token operator">:</span> <span class="token string">&#39;req&#39;</span><span class="token punctuation">,</span>
    optionalOption<span class="token operator">:</span> <span class="token string">&#39;default if nothing is set&#39;</span><span class="token punctuation">,</span>
    optionalWithDefaultOption<span class="token operator">:</span> <span class="token number">9090</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can also use your own service class implementation. This might be useful in some use cases.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ServiceBuilder<span class="token punctuation">,</span> ServiceInfoType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@purista/core&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;zod&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> myServiceInfo<span class="token operator">:</span> ServiceInfoType <span class="token operator">=</span> <span class="token punctuation">{</span>
  serviceName<span class="token operator">:</span> <span class="token string">&#39;MyService&#39;</span><span class="token punctuation">,</span>
  serviceVersion<span class="token operator">:</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span>
  serviceDescription<span class="token operator">:</span> <span class="token string">&#39;my service&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> myConfiguration <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  requiredOption<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  optionalOption<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  optionalWithDefaultOption<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> <span class="token class-name">ServiceConfigType</span> <span class="token operator">=</span> z<span class="token punctuation">.</span>output<span class="token operator">&lt;</span><span class="token keyword">typeof</span> myConfiguration<span class="token operator">&gt;</span>

<span class="token keyword">class</span> <span class="token class-name">CustomClass</span> <span class="token keyword">extends</span> <span class="token class-name">Service<span class="token operator">&lt;</span>ServiceConfigType<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token function">myClassMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;automatically available:&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>requiredOption<span class="token punctuation">)</span>
    <span class="token comment">// ...do something here</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> myServiceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceBuilder</span><span class="token punctuation">(</span>myServiceInfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setConfigSchema</span><span class="token punctuation">(</span>myConfiguration<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">setCustomClass</span><span class="token punctuation">(</span>CustomClass<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>As every function and subscription is running within the class context, the method <code>myClassMethod</code> will automatically be available by using <code>this.myClassMethod</code></p><h2 id="command-builder" tabindex="-1"><a class="header-anchor" href="#command-builder" aria-hidden="true">#</a> Command Builder</h2><p>For adding a function to a service, you should use the function builder. It is recommended to use the <code>getCommandBuilder</code> method of your service builder instance.</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> myCommandBuilder <span class="token operator">=</span> myServiceBuilder<span class="token punctuation">.</span><span class="token function">getCommandBuilder</span><span class="token punctuation">(</span><span class="token string">&#39;functionName&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;some function description&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;functionEventEmitted&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="subscription-builder" tabindex="-1"><a class="header-anchor" href="#subscription-builder" aria-hidden="true">#</a> Subscription Builder</h2>`,29),i=[p];function c(l,r){return s(),a("div",null,i)}const k=n(o,[["render",c],["__file","3_builders.html.vue"]]);export{k as default};
